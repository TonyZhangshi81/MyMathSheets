<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="AppData/Work/Content/image/favicon.ico">
    <link href="AppData/Work/Content/bootstrap.min.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/jquery-ui.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/icon.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/font-awesome.min.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/Shake.css" rel="stylesheet" charset="utf-8">

    <script src="AppData/Work/Scripts/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery.linq.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery.base64.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery.PrintArea.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery-ui.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/umd/popper.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/bootstrap.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/store.legacy.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/json2.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/snap/snap.svg-min.js"></script>
    <script src="AppData/Work/Scripts/jquery.rating-stars.min.js"></script>
    <script src="AppData/Work/Scripts/jquery.easing.1.3.js"></script>
    <script src="AppData/Work/Scripts/Ext/MathSheets.System.js" charset="utf-8"></script>

    <title>一起数学</title>
    <script type="text/javascript">

        // 站點信息
        var API_URL = "http://192.168.31.176:8081/";

        $(function () {
            topicManagement();

            $("#btnReady").click(function () { return btnReadyClick(this); });
        });

        showMessage = function (msg) {
            if (msg) {
                $("#spanMsg").text(msg);
            }

            $('#myModal').modal('show');
            setTimeout(function () {
                $("#myModal").modal("hide")
            }, 1200);
        }

        btnReadyClick = function (sender) {

            var settingList = getTopicSettingJson();
            if (settingList.length == 0) {
                showMessage('未選擇題型');
                return false;
            }

            $(sender).attr("disabled", true);

            var data = JSON.stringify(settingList);
            console.log(data);

            var apiUrl = API_URL + "api/Compile/Do";
            $.ajax({
                url: apiUrl,
                type: "POST",
                dataType: 'json',
                contentType: "application/json;charset=utf-8",
                data: data,

                beforeSend: function () {
                    $("<div class=\"datagrid-mask\"></div>").html("正在連接(" + apiUrl + ")，請等待...").appendTo("body");
                },

                complete: function (data) {
                    setTimeout(function () {
                        $('.datagrid-mask').hide(200, function () { $(".datagrid-mask").remove(); });
                    }, 400);
                },

                success: function (result) {
                    console.log(result);

                    setTimeout(function () {
                        showMessage();
                        $(sender).attr("disabled", false);

                        setTimeout(function () { linkOpen(result.Url); }, 1000);
                    }, 500);
                },

                error: function (xhr, textStatus, errorThrown) {
                    setTimeout(function () {
                        console.log(("狀態:" + xhr.status + " 狀態碼:" + xhr.readyState + " 錯誤信息:" + xhr.responseText));

                        showMessage("發生錯誤");
                        $(sender).attr("disabled", false);
                    }, 500);
                }
            });

            return false;
        }

        linkOpen = function (url) {
            var a = $("<a href='" + url + "' target='_blank' />").get(0);
            var e = document.createEvent('MouseEvents');
            e.initEvent('click', true, true);
            a.dispatchEvent(e);
        }

        topicManagement = function () {
            $.ajax({
                url: "Config/TopicManagement.json", // 讀取題型文件
                type: "GET",                        // 請求方式為get
                dataType: "json",                   // 返回數據格式為json
                success: function (data) {
                    // 遍歷返回的數據DATA
                    $.each(data, function (i, item) {
                        // 下拉列表框初期化
                        init(item.id, item.name);
                        // 題型編號列表框參數綁定
                        setTopicModule(item.id, item.name);
                    })
                }
            })
        }

        // 題型編號列表框參數綁定
        setTopicModule = function (id, name) {
            $.ajax({
                url: "Config/" + id + ".json",      // 讀取題型參數配置文件
                type: "GET",                        // 請求方式為get
                dataType: "json",                   // 返回數據格式為json
                success: function (data) {
                    // 題型編號下拉列表框
                    $ddl = $("#ddl" + id);
                    // 遍歷返回的數據DATA
                    $.each(data, function (i, item) {
                        var option = "<option value='" + item.Identifier + "'>" + item.Identifier + "</option>";
                        $ddl.append(option);
                    })
                }
            })
        }

        init = function (id, name) {
            // 題型名稱
            $span = $("#span" + id);
            $span.text(name);
            // 題型編號下拉列表框
            $ddl = $("#ddl" + id);
            $ddl.html("<option value=''>請選擇</option>");
        }

        getTopicSettingJson = function () {

            var topicManagements = [];
            $("select").each(function () {
                if ($(this).val() != "") {
                    var topicManagement = {};
                    topicManagement.Id = $(this).attr("id").substring(3);
                    topicManagement.Number = $(this).val();
                    topicManagements.push(topicManagement);
                }
            });

            return topicManagements;
        }
    </script>
    <style>
        div.datagrid-mask {
            height: 65px;
            text-align: center;
            background: yellowgreen;
            font-size: xx-large;
            z-index: 1;
            overflow: hidden;
            position: fixed;
            left: 0px;
            width: 100%;
            bottom: 0;
            top: expression(document.documentElement.clientHeight + document.documentElement.scrollTop - this.offsetHeight);
        }

        .modal-content {
            width: 340px;
            height: 80px;
            padding: 0.2rem 0.4rem;
            background-color: gold;
            text-align: center;
            line-height: 80px !important;
        }

        span.title {
            padding-right: 10px;
        }

        div.myContainer {
            background-color: cornflowerblue;
        }

        body {
            background-color: cornflowerblue;
        }
    </style>
</head>
<body>
    <div class="myContainer">
        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanArithmeticOperations" class="title"></span>
                            <select id="ddlArithmeticOperations"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanCombinatorialEquation" class="title"></span>
                            <select id="ddlCombinatorialEquation"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanComputingConnection" class="title"></span>
                            <select id="ddlComputingConnection"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanCurrencyLinkage" class="title"></span>
                            <select id="ddlCurrencyLinkage"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanCurrencyOperation" class="title"></span>
                            <select id="ddlCurrencyOperation"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanEqualityComparison" class="title"></span>
                            <select id="ddlEqualityComparison"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanEqualityLinkage" class="title"></span>
                            <select id="ddlEqualityLinkage"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanMathWordProblems" class="title"></span>
                            <select id="ddlMathWordProblems"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanFruitsLinkage" class="title"></span>
                            <select id="ddlFruitsLinkage"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanFindNearestNumber" class="title"></span>
                            <select id="ddlFindNearestNumber"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanFindTheLaw" class="title"></span>
                            <select id="ddlFindTheLaw"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanGapFillingProblems" class="title"></span>
                            <select id="ddlGapFillingProblems"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanHowMuchMore" class="title"></span>
                            <select id="ddlHowMuchMore"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanLearnCurrency" class="title"></span>
                            <select id="ddlLearnCurrency"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanLearnLengthUnit" class="title"></span>
                            <select id="ddlLearnLengthUnit"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanNumericSorting" class="title"></span>
                            <select id="ddlNumericSorting"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanSchoolClock" class="title"></span>
                            <select id="ddlSchoolClock"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanScoreGoal" class="title"></span>
                            <select id="ddlScoreGoal"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanTimeCalculation" class="title"></span>
                            <select id="ddlTimeCalculation"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanMathUpright" class="title"></span>
                            <select id="ddlMathUpright"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-1"><br /></div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanCleverCalculation" class="title"></span>
                            <select id="ddlCleverCalculation"></select>
                        </h4>
                    </div>
                    <div class="col-md-6 form-inline">
                        <h4>
                            <span id="spanRecursionEquation" class="title"></span>
                            <select id="ddlRecursionEquation"></select>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-1"><br /></div>
        </div>
    </div>

    <div class="clearfix" style="margin-bottom: 20px;"><br /></div>
    <div class="panel-footer">
        <div class="row">
            <div class="col-md-5"><br /></div>
            <div class="col-md-2">
                <p class="text-center">
                    <button id="btnReady" type="button" class="btn btn-lg btn-success btn-block">出題</button>
                </p>
            </div>
            <div class="col-md-5"><br /></div>
        </div>
    </div>

    <div class="modal fade bd-example-modal-sm" id="myModal" role="dialog" data-backdrop="false" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <p class="text-center mb-0">
                    <h2>
                        <i class="fa fa-check-circle text-success mr-3" aria-hidden="true"></i>
                        <span id="spanMsg">提交成功</span>
                    </h2>
                </p>
            </div>
        </div>
    </div>
</body>
</html>