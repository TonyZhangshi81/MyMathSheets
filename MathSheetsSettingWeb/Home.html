<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="AppData/Work/Content/image/favicon.ico">
    <link href="AppData/Work/Content/bootstrap.min.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/jquery-ui.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/icon.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/font-awesome.min.css" rel="stylesheet" charset="utf-8">
    <link href="AppData/Work/Content/Shake.css" rel="stylesheet" charset="utf-8">

    <script src="AppData/Work/Scripts/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery.linq.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery.base64.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery.PrintArea.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/jquery-ui.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/umd/popper.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/bootstrap.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/store.legacy.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/json2.min.js" charset="utf-8"></script>
    <script src="AppData/Work/Scripts/snap/snap.svg-min.js"></script>
    <script src="AppData/Work/Scripts/jquery.rating-stars.min.js"></script>
    <script src="AppData/Work/Scripts/jquery.easing.1.3.js"></script>
    <script src="AppData/Work/Scripts/Ext/MathSheets.System.js" charset="utf-8"></script>

    <title>一起数学</title>
    <script type="text/javascript">

        $(function () {
            topicManagement();

            $("#btnReady").click(function () { return btnReadyClick(); });
        });

        showMessage = function (msg) {
            if (msg) {
                $("#spanMsg").text(msg);
            }

            $('#myModal').modal('show');
            setTimeout(function () {
                $("#myModal").modal("hide")
            }, 1200);
        }

        btnReadyClick = function () {

            // 站點信息
            var apiUrl = "http://localhost:8081/";

            $.ajax({
                url: apiUrl + "api/Compile/Do",
                type: "POST",
                dataType: 'json',
                contentType: "application/json;charset=utf-8",
                data: getTopicSettingJsonString(), 

                beforeSend: function () {
                    $(this).attr("disabled", false);
                    $("<div class=\"datagrid-mask\"></div>").html("Please Wait...").appendTo("body");
                },
                complete: function (data) {
                    setTimeout(function () {
                        $('.datagrid-mask').hide(200);
                        $(this).attr("disabled", true);
                    }, 400);
                },
                success: function (result) {
                    console.log(result);

                    setTimeout(function () {
                        showMessage();
                        $(this).attr("disabled", true);

                        setTimeout(function () { linkOpen(result.Url); }, 1000);
                    }, 500);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    setTimeout(function () {
                        showMessage(("status:" + XMLHttpRequest.status + " readyState:" + XMLHttpRequest.readyState + " textStatus:" + textStatus));
                        $(this).attr("disabled", true);
                    }, 500);
                }
            });

            return false;
        }

        linkOpen = function (url) {
            var a = $("<a href='" + url + "' target='_blank' />").get(0);
            var e = document.createEvent('MouseEvents');
            e.initEvent('click', true, true);
            a.dispatchEvent(e);
        }

        topicManagement = function () {
            $.ajax({
                url: "Config/TopicManagement.json", // 讀取題型文件
                type: "GET",                        // 請求方式為get
                dataType: "json",                   // 返回數據格式為json
                success: function (data) {
                    // 遍歷返回的數據DATA
                    $.each(data, function (i, item) {
                        // 下拉列表框初期化
                        init(item.id, item.name);
                        // 題型編號列表框參數綁定
                        setTopicModule(item.id, item.name);
                    })
                }
            })
        }

        // 題型編號列表框參數綁定
        setTopicModule = function (id, name) {
            $.ajax({
                url: "Config/" + id + ".json",      // 讀取題型參數配置文件
                type: "GET",                        // 請求方式為get
                dataType: "json",                   // 返回數據格式為json
                success: function (data) {
                    // 題型編號下拉列表框
                    $ddl = $("#ddl" + id);
                    // 遍歷返回的數據DATA
                    $.each(data, function (i, item) {
                        var option = "<option value='" + item.Identifier + "'>" + item.Identifier + "</option>";
                        $ddl.append(option);
                    })
                }
            })
        }

        init = function (id, name) {
            // 題型名稱
            $span = $("#span" + id);
            $span.text(name);
            // 題型編號下拉列表框
            $ddl = $("#ddl" + id);
            $ddl.html("<option value=''>請選擇</option>");
        }

        getTopicSettingJsonString = function () {

            var topicManagements = [];
            $("select").each(function () {
                if ($(this).val() != "") {
                    var topicManagement = {};
                    topicManagement.Id = $(this).attr("id").substring(3);
                    topicManagement.Number = $(this).val();
                    topicManagements.push(topicManagement);
                }
            });

            var jsonStr = JSON.stringify(topicManagements);
            console.log(jsonStr);
            return jsonStr;
        }
    </script>
    <style>
        div.datagrid-mask {
            height: auto;
            text-align: center;
            background: #b6ff00;
            z-index: 1;
            overflow: hidden;
            position: fixed;
            left: 0px;
            width: 100%;
            bottom: 0;
            top: expression(document.documentElement.clientHeight + document.documentElement.scrollTop - this.offsetHeight);
        }

        .modal-content {
            width: 200px;
            padding: 0.2rem 0.4rem;
            background-color: gold;
        }
    </style>
</head>
<body>
    <div class="container" style="background-color: floralwhite">
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanArithmeticOperations"></span></h5>
                <select id="ddlArithmeticOperations"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanCombinatorialEquation"></span></h5>
                <select id="ddlCombinatorialEquation"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanComputingConnection"></span></h5>
                <select id="ddlComputingConnection"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>

        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanCurrencyLinkage"></span></h5>
                <select id="ddlCurrencyLinkage"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanCurrencyOperation"></span></h5>
                <select id="ddlCurrencyOperation"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanEqualityComparison"></span></h5>
                <select id="ddlEqualityComparison"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanEqualityLinkage"></span></h5>
                <select id="ddlEqualityLinkage"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanMathWordProblems"></span></h5>
                <select id="ddlMathWordProblems"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanFruitsLinkage"></span></h5>
                <select id="ddlFruitsLinkage"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanFindNearestNumber"></span></h5>
                <select id="ddlFindNearestNumber"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanFindTheLaw"></span></h5>
                <select id="ddlFindTheLaw"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanGapFillingProblems"></span></h5>
                <select id="ddlGapFillingProblems"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanHowMuchMore"></span></h5>
                <select id="ddlHowMuchMore"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanLearnCurrency"></span></h5>
                <select id="ddlLearnCurrency"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanLearnLengthUnit"></span></h5>
                <select id="ddlLearnLengthUnit"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanNumericSorting"></span></h5>
                <select id="ddlNumericSorting"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanSchoolClock"></span></h5>
                <select id="ddlSchoolClock"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanScoreGoal"></span></h5>
                <select id="ddlScoreGoal"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanTimeCalculation"></span></h5>
                <select id="ddlTimeCalculation"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanMathUpright"></span></h5>
                <select id="ddlMathUpright"></select>
            </div>
            <div class="col-md-4 form-inline">
                <h5><span id="spanCleverCalculation"></span></h5>
                <select id="ddlCleverCalculation"></select>
            </div>
        </div>

        <div class="clearfix" style="margin-bottom: 10px;"></div>
        <div class="row">
            <div class="col-md-4 form-inline">
                <h5><span id="spanRecursionEquation"></span></h5>
                <select id="ddlRecursionEquation"></select>
            </div>
        </div>
    </div>
    <div class="clearfix" style="margin-bottom: 30px;"></div>
    <div class="panel-footer">
        <div class="row">
            <div class="col-md-12 col-md-offset-3">
                <p class="text-center">
                    <button id="btnReady" type="button" class="btn btn-lg btn-success">出題</button>
                </p>
            </div>
        </div>
    </div>

    <!-- data-backdrop="false"去除遮罩层  -->
    <div class="modal fade bd-example-modal-sm" id="myModal" role="dialog" data-backdrop="false" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <p class="text-center mb-0">
                    <i class="fa fa-check-circle text-success mr-1" aria-hidden="true"></i>
                    <span id="spanMsg">提交成功</span>
                </p>
            </div>
        </div>
    </div>
</body>
</html>